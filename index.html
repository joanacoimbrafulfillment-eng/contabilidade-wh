<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH Pro - Cloud Financial System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --cgd: #0056b3; --capital: #8e44ad; --success: #27ae60; --danger: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        .nav-tabs { background: var(--primary); display: flex; padding: 0 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .tab-btn { background: none; border: none; color: #bdc3c7; padding: 15px 25px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.3s; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid var(--success); }

        .container { max-width: 1550px; margin: 30px auto; padding: 0 20px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        .top-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid var(--primary); }
        .card h3 { margin: 0; font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; }
        .card .val { font-size: 1.8em; font-weight: bold; margin-top: 5px; display: block; }

        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .box h4 { margin: 0 0 15px 0; font-size: 0.9em; border-bottom: 1px solid #eee; padding-bottom: 8px; color: var(--primary); text-transform: uppercase; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 12px; align-items: flex-end; }
        label { display: block; font-size: 0.65em; font-weight: bold; margin-bottom: 5px; color: #666; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; box-sizing: border-box; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-add { background: var(--success); }
        .btn-del { background: #ff7675; font-size: 0.75em; padding: 3px 7px; border-radius: 4px; border:none; color:white; }

        .table-container { background: white; border-radius: 8px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 10px; text-align: left; font-size: 0.65em; color: #999; text-transform: uppercase; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; font-size: 0.8em; }
        
        .income-text { color: var(--success); font-weight: bold; }
        .expense-text { color: var(--danger); font-weight: bold; }

        /* Compact Entity List */
        .entity-tag-list { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; padding-right: 5px; }
        .entity-item { display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; padding: 4px 8px; border: 1px solid #eee; border-radius: 4px; font-size: 0.75em; }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <div id="loader"><h2>Connecting to WH Cloud...</h2></div>

    <nav class="nav-tabs">
        <button class="tab-btn active" data-tab="tab-entry">Entry & Balances</button>
        <button class="tab-btn" data-tab="tab-history">Transactions History</button>
        <button class="tab-btn" data-tab="tab-dashboard">Visual Dashboard</button>
    </nav>

    <div class="container">
        <!-- GLOBAL BALANCES -->
        <div class="top-summary">
            <div class="card" style="border-left-color: var(--cgd)"><h3>WH MAIN CGD</h3><span id="cgd-balance" class="val">0.00 €</span></div>
            <div class="card" style="border-left-color: var(--capital)"><h3>CAPITAL FUND WH</h3><span id="cap-balance" class="val">0.00 €</span></div>
            <div class="card" style="background: var(--primary); color: white;"><h3 style="color: #bdc3c7">TOTAL CONSOLIDATED</h3><span id="grand-total" class="val">0.00 €</span></div>
        </div>

        <!-- TAB 1: ENTRY & BALANCES -->
        <div id="tab-entry" class="tab-content active">
            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px; align-items: start;">
                
                <!-- LEFT COLUMN: MAIN ACTIONS -->
                <div>
                    <div class="box">
                        <h4>Opening Balances</h4>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
                            <div><label>CGD Start</label><input type="number" id="init-cgd" value="0.00" step="0.01"></div>
                            <div><label>Cap Start</label><input type="number" id="init-cap" value="0.00" step="0.01"></div>
                            <button class="btn" id="btn-save-balances" style="background:var(--primary)">Save</button>
                        </div>
                    </div>

                    <div class="box">
                        <h4>New Transaction</h4>
                        <div class="form-grid">
                            <div><label>Year</label><select id="sel-year"></select></div>
                            <div><label>Month</label><select id="sel-month"></select></div>
                            <div><label>Date</label><input type="date" id="ipt-date"></div>
                            <div><label>Entity</label><select id="sel-place"></select></div>
                            <div><label>Bank</label><select id="sel-bank"><option value="WH MAIN CGD">WH MAIN CGD</option><option value="CAPITAL FUND WH">CAPITAL FUND WH</option></select></div>
                            <div><label>Type</label><select id="sel-type"><option value="Expense">Expense</option><option value="Income">Income</option></select></div>
                            <div><label>Net Val</label><input type="number" id="ipt-net" step="0.01"></div>
                            <div><label>VAT</label><input type="number" id="ipt-vat" step="0.01"></div>
                            <div><label>Total</label><input type="number" id="ipt-total" step="0.01" readonly></div>
                            <button class="btn btn-add" id="btn-register">Register</button>
                        </div>
                    </div>

                    <div class="box">
                        <h4>Recent Activity</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>Date</th><th>Entity</th><th>Bank</th><th>Type</th><th align="right">Total</th></tr>
                                </thead>
                                <tbody id="table-recent">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: MINI TOOLS -->
                <div>
                    <div class="box" style="padding: 15px;">
                        <h4>Manage Entities</h4>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <input type="text" id="ipt-new-entity" placeholder="Name..." style="padding: 6px; font-size: 12px; text-transform: uppercase;">
                            <button class="btn" id="btn-add-entity" style="background: var(--capital); padding: 5px 10px; font-size: 11px;">Add</button>
                        </div>
                        <div class="entity-tag-list" id="list-entities">
                            <!-- Entities list -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- TAB 2: HISTORY -->
        <div id="tab-history" class="tab-content">
            <div class="box" style="padding:15px">
                <div class="form-grid">
                    <div><label>Year</label><select id="hist-f-year"><option value="All">All Years</option></select></div>
                    <div><label>Month</label><select id="hist-f-month"><option value="All">All Months</option></select></div>
                    <div><label>Entity</label><select id="hist-f-place"><option value="All">All Entities</option></select></div>
                    <button class="btn" id="btn-export-excel" style="background:var(--success)">Export CSV</button>
                </div>
            </div>
            <div class="table-container box">
                <table style="min-width: 1000px;">
                    <thead><tr><th>Year</th><th>Month</th><th>Date</th><th>Entity</th><th>Bank</th><th>Type</th><th>Net</th><th>VAT</th><th>Total</th><th>Action</th></tr></thead>
                    <tbody id="table-history-body"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 3: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content">
            <div class="dash-results-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center; margin-bottom: 20px;">
                <div class="box"><h3>INCOME</h3><b id="dash-num-inc" class="income-text" style="font-size:1.5em">0.00 €</b></div>
                <div class="box"><h3>EXPENSE</h3><b id="dash-num-exp" class="expense-text" style="font-size:1.5em">0.00 €</b></div>
                <div class="box"><h3>NET RESULT</h3><b id="dash-num-net" style="font-size:1.5em">0.00 €</b></div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
                <div class="box"><canvas id="barChart" height="350"></canvas></div>
                <div class="box"><canvas id="pieChart" height="350"></canvas></div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAR7IwVllLB8NSzWHOEDzEpn1DZV1OzcKQ",
        authDomain: "contabilidade-wh.firebaseapp.com",
        projectId: "contabilidade-wh",
        storageBucket: "contabilidade-wh.firebasestorage.app",
        messagingSenderId: "396012748902",
        appId: "1:396012748902:web:6cf018558a3a2a2beeeda7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const years = [];
    for (let y = 2023; y <= 2035; y++) { years.push(y.toString()); }
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    let entities = [];
    let transactions = [];
    let barChart, pieChart;

    window.onload = () => {
        const sy = document.getElementById('sel-year'); const hfy = document.getElementById('hist-f-year');
        const sm = document.getElementById('sel-month'); const hfm = document.getElementById('hist-f-month');
        years.forEach(y => { sy.innerHTML += `<option>${y}</option>`; hfy.innerHTML += `<option>${y}</option>`; });
        months.forEach(m => { sm.innerHTML += `<option>${m}</option>`; hfm.innerHTML += `<option>${m}</option>`; });
        sy.value = new Date().getFullYear().toString();
        document.getElementById('ipt-date').valueAsDate = new Date();
        
        initCharts();
        loadBalances();
        listenEntities();
        listenTransactions();
        setupTabs();
        [hfy, hfm, document.getElementById('hist-f-place')].forEach(el => el.addEventListener('change', updateUI));
    };

    // --- ENTITIES ---
    function listenEntities() {
        onSnapshot(query(collection(db, "entities"), orderBy("name", "asc")), (snapshot) => {
            entities = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
            updateEntityUI();
        });
    }

    document.getElementById('btn-add-entity').onclick = async () => {
        const name = document.getElementById('ipt-new-entity').value.trim().toUpperCase();
        if(!name) return;
        if(entities.some(e => e.name === name)) return alert("Exists");
        await addDoc(collection(db, "entities"), { name });
        document.getElementById('ipt-new-entity').value = "";
    };

    window.deleteEntity = async (id) => {
        if(confirm("Remove entity from list?")) await deleteDoc(doc(db, "entities", id));
    };

    function updateEntityUI() {
        const sel = document.getElementById('sel-place');
        const filt = document.getElementById('hist-f-place');
        const list = document.getElementById('list-entities');
        const curSel = sel.value;
        sel.innerHTML = "";
        filt.innerHTML = '<option value="All">All Entities</option>';
        list.innerHTML = "";
        entities.forEach(ent => {
            sel.innerHTML += `<option value="${ent.name}">${ent.name}</option>`;
            filt.innerHTML += `<option value="${ent.name}">${ent.name}</option>`;
            list.innerHTML += `<div class="entity-item"><span>${ent.name}</span><button class="btn-del" onclick="deleteEntity('${ent.id}')">x</button></div>`;
        });
        sel.value = curSel;
    }

    // --- LOGIC ---
    function autoCalc() {
        const n = parseFloat(document.getElementById('ipt-net').value) || 0;
        const v = parseFloat(document.getElementById('ipt-vat').value) || 0;
        document.getElementById('ipt-total').value = (n + v).toFixed(2);
    }
    document.getElementById('ipt-net').oninput = autoCalc;
    document.getElementById('ipt-vat').oninput = autoCalc;

    async function loadBalances() {
        const snap = await getDoc(doc(db, "settings", "balances"));
        if(snap.exists()) {
            document.getElementById('init-cgd').value = snap.data().cgd;
            document.getElementById('init-cap').value = snap.data().cap;
        }
    }

    document.getElementById('btn-save-balances').onclick = async () => {
        await setDoc(doc(db, "settings", "balances"), { cgd: parseFloat(document.getElementById('init-cgd').value), cap: parseFloat(document.getElementById('init-cap').value) });
        alert("Balances Saved!"); updateUI();
    };

    document.getElementById('btn-register').onclick = async () => {
        const total = parseFloat(document.getElementById('ipt-total').value);
        if(!total || total <= 0) return alert("Error");
        const data = { year: document.getElementById('sel-year').value, month: document.getElementById('sel-month').value, date: document.getElementById('ipt-date').value, place: document.getElementById('sel-place').value, bank: document.getElementById('sel-bank').value, type: document.getElementById('sel-type').value, net: parseFloat(document.getElementById('ipt-net').value) || 0, vat: parseFloat(document.getElementById('ipt-vat').value) || 0, total: total, ts: Date.now() };
        await addDoc(collection(db, "transactions"), data);
        document.getElementById('ipt-net').value = ""; document.getElementById('ipt-vat').value = ""; document.getElementById('ipt-total').value = "";
    };

    function listenTransactions() {
        onSnapshot(query(collection(db, "transactions"), orderBy("ts", "desc")), (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateUI(); document.getElementById('loader').style.display = 'none';
        });
    }

    function updateUI() {
        const hBody = document.getElementById('table-history-body');
        const rBody = document.getElementById('table-recent');
        const fY = document.getElementById('hist-f-year').value;
        const fM = document.getElementById('hist-f-month').value;
        const fP = document.getElementById('hist-f-place').value;
        hBody.innerHTML = ""; rBody.innerHTML = "";
        
        let cgd = parseFloat(document.getElementById('init-cgd').value) || 0;
        let cap = parseFloat(document.getElementById('init-cap').value) || 0;

        transactions.forEach((m, idx) => {
            if(m.bank === "WH MAIN CGD") cgd += (m.type === "Income" ? m.total : -m.total);
            else cap += (m.type === "Income" ? m.total : -m.total);
            
            if((fY === "All" || m.year === fY) && (fM === "All" || m.month === fM) && (fP === "All" || m.place === fP)) {
                hBody.innerHTML += `<tr><td class="editable" contenteditable="true" onblur="updateField('${m.id}', 'year', this.innerText)">${m.year}</td><td class="editable" contenteditable="true" onblur="updateField('${m.id}', 'month', this.innerText)">${m.month}</td><td>${m.date}</td><td class="editable" contenteditable="true" onblur="updateField('${m.id}', 'place', this.innerText)">${m.place}</td><td>${m.bank}</td><td>${m.type}</td><td align="right">${m.net.toFixed(2)}</td><td align="right">${m.vat.toFixed(2)}</td><td align="right" class="${m.type==='Income'?'income-text':'expense-text'}">${m.total.toFixed(2)}€</td><td><button class="btn-del" onclick="deleteEntry('${m.id}')">Del</button></td></tr>`;
            }

            if(idx < 5) {
                rBody.innerHTML += `<tr><td>${m.date}</td><td>${m.place}</td><td>${m.bank}</td><td>${m.type}</td><td align="right" class="${m.type==='Income'?'income-text':'expense-text'}">${m.total.toFixed(2)}€</td></tr>`;
            }
        });
        document.getElementById('cgd-balance').innerText = cgd.toLocaleString('pt-PT', {style:'currency',currency:'EUR'});
        document.getElementById('cap-balance').innerText = cap.toLocaleString('pt-PT', {style:'currency',currency:'EUR'});
        document.getElementById('grand-total').innerText = (cgd + cap).toLocaleString('pt-PT', {style:'currency',currency:'EUR'});
        refreshDashboard();
    }

    window.updateField = async (id, field, val) => { await updateDoc(doc(db, "transactions", id), { [field]: val }); };
    window.deleteEntry = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "transactions", id)); };

    document.getElementById('btn-export-excel').onclick = () => {
        const headers = ["Year", "Month", "Date", "Entity", "Bank", "Type", "Net", "VAT", "Total"];
        let csv = headers.join(";") + "\n";
        transactions.forEach(m => { csv += [m.year, m.month, m.date, `"${m.place}"`, m.bank, m.type, m.net.toString().replace(".", ","), m.vat.toString().replace(".", ","), m.total.toString().replace(".", ",")].join(";") + "\n"; });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' })));
        link.setAttribute("download", `Report.csv`);
        link.click();
    };

    function refreshDashboard() {
        let inc = 0, exp = 0; let mData = {}; months.forEach(m => mData[m] = { inc: 0, exp: 0 }); let eData = {};
        transactions.forEach(m => {
            if(m.type === "Income") inc += m.total; else exp += m.total;
            mData[m.month][m.type === "Income" ? 'inc' : 'exp'] += m.total;
            if(m.type === "Expense") eData[m.place] = (eData[m.place] || 0) + m.total;
        });
        document.getElementById('dash-num-inc').innerText = inc.toLocaleString('pt-PT') + " €";
        document.getElementById('dash-num-exp').innerText = exp.toLocaleString('pt-PT') + " €";
        const net = inc - exp; document.getElementById('dash-num-net').innerText = net.toLocaleString('pt-PT') + " €";
        document.getElementById('dash-num-net').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
        barChart.data.datasets[0].data = months.map(m => mData[m].inc);
        barChart.data.datasets[1].data = months.map(m => mData[m].exp);
        barChart.update();
        const sorted = Object.entries(eData).sort((a,b) => b[1] - a[1]).slice(0, 5);
        pieChart.data.labels = sorted.map(e => e[0]); pieChart.data.datasets[0].data = sorted.map(e => e[1]); pieChart.update();
    }

    function initCharts() {
        barChart = new Chart(document.getElementById('barChart').getContext('2d'), { type: 'bar', data: { labels: months, datasets: [{ label: 'Income', backgroundColor: '#27ae60', data: [] }, { label: 'Expense', backgroundColor: '#e74c3c', data: [] }] }, options: { responsive: true, maintainAspectRatio: false } });
        pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3498db','#9b59b6','#f1c40f','#e67e22','#1abc9c'] }] }, options: { responsive: true, maintainAspectRatio: false } });
    }

    function setupTabs() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active'); document.getElementById(e.target.dataset.tab).classList.add('active');
                if(e.target.dataset.tab === 'tab-dashboard') { barChart.resize(); pieChart.resize(); }
            }
        });
    }
</script>
</body>
</html>
